<!DOCTYPE html>
<html lang="en-us">
  <head>
  <meta charset="UTF-8">
  <title>Minke</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link rel="stylesheet" href="css/normalize.css">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="css/cayman.css">
  <link rel="stylesheet" href="css/highlighting.css">
  <link rel="stylesheet" href="css/menu.css">
  <link rel="stylesheet" href="css/asciinema-player.css">
  <script src="css/menu.js"></script>
</head>


  <body>

    <section class="menu">
  <ul class="topnav">
    <li><a href="index.html">Home</a></li>
    <li><a href="tutorial.html">Tutorial</a></li>
    <!--
    <li><a href="#news">Config Files</a></li>
    <li><a href="#contact">Functional Tests</a></li>
    <li><a href="#contact">Extending Minke</a></li>
    <li><a href="#contact">Using Custom Generators</a></li>
    -->
    <li><a href="changelog.html">Change Log</a></li>
    <li><a href="about.html">About</a></li>
    <li class="icon">
      <a href="javascript:void(0);" onclick="showHideMenu()">&#9776;</a>
    </li>
  </ul>
</section>


    

    <section class="main-content">

      <div id="home">
  
  <h1 id="tutorial">Tutorial</h1>
<p>Following on from the quick start lets have a little deeper look at how Minke actually works.</p>

<h2 id="run-minke">Run minke</h2>
<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -Ls https://get.minke.rocks | bash -s <span class="s1">'minke'</span>
</code></pre>
</div>

<p>You should see the below output showing the help options and the currently installed generators.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>888b     d888 d8b          888
8888b   d8888 Y8P          888
88888b.d88888              888
888Y88888P888 888 88888b.  888  888  .d88b.
888 Y888P 888 888 888 "88b 888 .88P d8P  Y8b
888  Y8P  888 888 888  888 888888K  88888888
888   "   888 888 888  888 888 "88b Y8b.
888       888 888 888  888 888  888  "Y8888

Version: 1.12.3

# Loading installed generators
registered minke-generator-go
registered minke-generator-netmvc
registered minke-generator-swift


Usage: minke [options]
    -e, --encrypt STRING             Encrypt a string
    -k, --key STRING                 Private key to use for encryption
    -g, --generator GENERATOR        Generator plugin to use
    -o, --output OUTPUT              Output folder
    -a, --application_name NAME      Application name
    -n, --namespace NAMESPACE        Application namespace
</code></pre>
</div>

<h2 id="scaffold-a-project">Scaffold a project</h2>
<p>We can now scaffold a new go μService using the following command:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>curl -Ls https://get.minke.rocks | bash -s <span class="s1">'generate -g minke-generator-go -o $(pwd) -n github.com/nicholasjackson -a myservice'</span>
</code></pre>
</div>

<p>If look at the output folder we will see something like the below folder structure, all our source code is in the root and there is a <strong>_build</strong> folder, this is where Minke stores things like the Docker and Docker Compose files and configuration.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>0 drwxr-xr-x   9 nicj  129917615   306 22 Jun 16:31 .
0 drwxr-xr-x  15 nicj  129917615   510 22 Jun 16:30 ..
8 -rw-r--r--   1 nicj  129917615     9 22 Jun 16:31 .gitignore
0 drwxr-xr-x  14 nicj  129917615   476 22 Jun 16:31 _build
0 drwxr-xr-x   3 nicj  129917615   102 22 Jun 16:31 global
0 drwxr-xr-x  10 nicj  129917615   340 22 Jun 16:31 handlers
0 drwxr-xr-x   3 nicj  129917615   102 22 Jun 16:31 logging
8 -rw-r--r--   1 nicj  129917615  1582 22 Jun 16:31 main.go
0 drwxr-xr-x   3 nicj  129917615   102 22 Jun 16:31 mocks
</code></pre>
</div>

<h2 id="building-and-testing-your-application">Building and testing your application</h2>
<p>Change to the <strong>_build</strong> folder</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cd _build
</code></pre>
</div>
<p>To avoid the pain of having to craft a ridiculously long docker run cmd every time you want to run a command there is a bash script <code class="highlighter-rouge">minke.sh</code> in the build folder.  This simply runs the commands specified as arguments inside the Minke Docker container.  The parent folder to _build (source root) is mapped as a volume inside the container with the same path as your local folder and the working directory is set to _build folder.</p>

<p>To see the various options available to you, you can run <code class="highlighter-rouge">$ ./minke --help</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>build              # build application
build_and_run      # build and run application with Docker Compose
build_image        # build Docker image for application
cucumber[feature]  # run end to end Cucumber tests USAGE: rake app:cucumber[@tag]
fetch              # fetch dependent packages
push               # push built image to Docker registry
run                # run application with Docker Compose
test               # run unit tests
fetch_images    # pull images for golang from Docker registry if not already downloaded
update_images   # updates build images for swagger and golang will overwrite existing images
</code></pre>
</div>

<h3 id="building-the-application">Building the application</h3>
<p>To build the application simply execute:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>./minke build
</code></pre>
</div>
<p>The steps minke performs are:
1. Download Docker image or build image specified by the generator.
2. Start a new build container.
3. Fetch any dependencies.
4. Execute build command specified by the generator.</p>

<p>The output will look something like below.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># Loading installed generators</span>
registered minke-generator-go
registered minke-generator-netmvc
registered minke-generator-swift
run fetch
<span class="c">## Update dependencies</span>
/Users/nicj/Developer/crapola:/go/src/github.com/nicholasjackson/myservice
/Users/nicj/Developer/crapola/vendor:/packages/src
github.com/alexcesaro/statsd <span class="o">(</span>download<span class="o">)</span>
Fetching https://gopkg.in/alexcesaro/statsd.v2?go-get<span class="o">=</span>1
Parsing meta tags from https://gopkg.in/alexcesaro/statsd.v2?go-get<span class="o">=</span>1 <span class="o">(</span>status code 200<span class="o">)</span>
get <span class="s2">"gopkg.in/alexcesaro/statsd.v2"</span>: found meta tag main.metaImport<span class="o">{</span>Prefix:<span class="s2">"gopkg.in/alexcesaro/statsd.v2"</span>, VCS:<span class="s2">"git"</span>, RepoRoot:<span class="s2">"https://gopkg.in/alexcesaro/statsd.v2"</span><span class="o">}</span> at https://gopkg.in/alexcesaro/statsd.v2?go-get<span class="o">=</span>1
gopkg.in/alexcesaro/statsd.v2 <span class="o">(</span>download<span class="o">)</span>
github.com/facebookgo/inject <span class="o">(</span>download<span class="o">)</span>
github.com/facebookgo/structtag <span class="o">(</span>download<span class="o">)</span>
github.com/facebookgo/ensure <span class="o">(</span>download<span class="o">)</span>
github.com/davecgh/go-spew <span class="o">(</span>download<span class="o">)</span>
github.com/facebookgo/stack <span class="o">(</span>download<span class="o">)</span>
github.com/facebookgo/subset <span class="o">(</span>download<span class="o">)</span>
github.com/asaskevich/govalidator <span class="o">(</span>download<span class="o">)</span>
github.com/gorilla/context <span class="o">(</span>download<span class="o">)</span>
github.com/gorilla/pat <span class="o">(</span>download<span class="o">)</span>
github.com/gorilla/mux <span class="o">(</span>download<span class="o">)</span>
github.com/stretchr/testify <span class="o">(</span>download<span class="o">)</span>
Downloaded packages
<span class="c">## Build application</span>
<span class="o">[</span><span class="s2">"/bin/bash"</span>, <span class="s2">"-c"</span>, <span class="s2">"go build -a -installsuffix cgo -ldflags '-s' -o myservice"</span><span class="o">]</span>
/Users/nicj/Developer/crapola:/go/src/github.com/nicholasjackson/myservice
/Users/nicj/Developer/crapola/vendor:/packages/src
</code></pre>
</div>

<p>The build task has a dependency on the fetch task so before we try to build anything we will fetch the dependencies (in this instance using go get) before executing the build.<br />
All of the code is run inside the docker container however most generators will use the physical disk of the Docker server to cache the output.  This speeds up the whole process and allows you to utilise any caching behavior of your CI environment if needed.</p>

<h3 id="running-the-unit-tests">Running the unit tests</h3>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>./minke rake <span class="nb">test</span>
</code></pre>
</div>
<p>Running the unit tests is a similar process, before we run the tests we will build the application code and fetch any dependencies.   It all runs inside a container.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c">## Test application</span>
/Users/nicj/Developer/crapola:/go/src/github.com/nicholasjackson/crapola
/Users/nicj/Developer/crapola/vendor:/packages/src
?   	github.com/nicholasjackson/crapola	        <span class="o">[</span>no <span class="nb">test </span>files]
?   	github.com/nicholasjackson/crapola/global	<span class="o">[</span>no <span class="nb">test </span>files]
ok  	github.com/nicholasjackson/crapola/handlers	0.013s
?   	github.com/nicholasjackson/crapola/logging	<span class="o">[</span>no <span class="nb">test </span>files]
?   	github.com/nicholasjackson/crapola/mocks	<span class="o">[</span>no <span class="nb">test </span>files]
</code></pre>
</div>

<h3 id="build-yourself-an-image">Build yourself an image</h3>
<p>So we are going to run the cucumber tests against a Docker container and ultimately you want to run this on your server anyway so lets build an image which can be launched.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>./minke build_image
</code></pre>
</div>

<p>That’s all you need this will build and test your application code then copy the assets into the right location to be packaged up into a Docker image, all of the steps is configurable checkout the section on Config for more information.</p>

<h3 id="functional-tests">Functional tests</h3>
<p>Having unit tests for your code covers you a little however there is a real benefit to having a good behavioral test suite which may even test the integration of your application with other dependencies such as database servers.
Minke uses Cucumber and Docker to facilitate this, it spins up a stack using Docker Compose and executes the Cucumber tests against it.<br />
Running the functional tests is as easy as…</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>./minke cucumber
</code></pre>
</div>

<p>This will start the stack with Docker Compose using a standard format compose file which can be found in the <strong>_build</strong> folder, it loads any config that we may require for the service into Consul and then waits for the service to start before executing the Cucumber tests.<br />
And you have to do nothing other than write the test and setup the config all logic for service discovery and waiting for the service to start is handled for you.
All being well you should see some output like the stuff listed below.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># Loading installed generators</span>
registered minke-generator-netmvc
<span class="c">## Running cucumber with tags</span>
Creating apiipad_statsd_1
Creating apiipad_consul_1
Creating apiipad_registrator_1
Creating apiipad_apiipad_1
Server: http://192.168.99.100:32886/v1/status/leader passed health check, 1 checks to go...
Server: http://192.168.99.100:32886/v1/status/leader healthy
./consul_keys.yml
Updating key: /apiipad/Credentials/mysql/username with value: root
Updating key: /apiipad/Credentials/mysql/password with value: my-secret-pw
Updating key: /apiipad/Settings/environment with value: dev
Updating key: /apiipad/Settings/mysql/db_name with value: apiipad
Updating key: /apiipad/Settings/statsd/host with value: statsd
Updating key: /apiipad/Settings/statsd/port with value: 8125
Waiting <span class="k">for </span>server http://192.168.99.100:32888/v1/health to start
Server: http://192.168.99.100:32888/v1/health passed health check, 3 checks to go...

...

@healthcheck
Feature: Health check
	In order to ensure quality
	As a user
	I want to be able to <span class="nb">test </span>functionality of my API

  Scenario: Health check returns ok                            <span class="c"># features/health.feature:10</span>
    Given I send and accept JSON                               <span class="c"># cucumber-api-0.3/lib/cucumber-api/steps.rb:11</span>
    When I send a GET request to the api endpoint <span class="s2">"/v1/health"</span> <span class="c"># features/steps/http.rb:1</span>
    Then the response status should be <span class="s2">"200"</span>                   <span class="c"># cucumber-api-0.3/lib/cucumber-api/steps.rb:107</span>
    And the JSON response should have key <span class="s2">"status"</span>             <span class="c"># cucumber-api-0.3/lib/cucumber-api/steps.rb:132</span>

1 scenario <span class="o">(</span>1 passed<span class="o">)</span>
4 steps <span class="o">(</span>4 passed<span class="o">)</span>
0m0.026s
Stopping apiipad_apiipad_1 ... <span class="k">done
</span>Stopping apiipad_registrator_1 ... <span class="k">done
</span>Stopping apiipad_consul_1 ... <span class="k">done
</span>Stopping apiipad_statsd_1 ... <span class="k">done</span>
</code></pre>
</div>

<p>It really is that easy now all you need to do is push the image to the server and open a beer.  If you have managed to get this far I recommend checking out the documentation on the configuration files to see how you can customise and extend your build.</p>

</div>


      <footer class="site-footer">
  <script language="javascript" src="/js/asciinema-player.js"></script>
  <span class="site-footer-owner"><a href="">Minke</a> is maintained by <a href="http://github.com/nicholasjackson">Nic Jackson</a>.</span>
  <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/pietromenna/jekyll-cayman-theme">Cayman theme</a> by <a href="http://github.com/jasonlong">Jason Long</a>.</span>
</footer>


    </section>

  </body>
</html>
